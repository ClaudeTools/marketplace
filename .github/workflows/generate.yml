name: Generate Plugin Directories

on:
  schedule:
    - cron: '0 6 * * *'  # Daily at 06:00 UTC
  workflow_dispatch:

permissions:
  contents: write

jobs:
  generate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Fetch approved extensions
        env:
          MARKETPLACE_SERVICE_TOKEN: ${{ secrets.MARKETPLACE_SERVICE_TOKEN }}
        run: |
          curl -sf \
            -H "X-Service-Token: $MARKETPLACE_SERVICE_TOKEN" \
            "https://claudetools.com/api/marketplace/export" \
            -o extensions.json

      - name: Generate plugin directories
        run: |
          node -e "
          const fs = require('fs');
          const path = require('path');
          const data = JSON.parse(fs.readFileSync('extensions.json', 'utf8'));
          const exts = data.data?.extensions || {};

          // Clean existing generated plugins
          const pluginsDir = 'plugins';
          if (fs.existsSync(pluginsDir)) {
            fs.rmSync(pluginsDir, { recursive: true });
          }
          fs.mkdirSync(pluginsDir, { recursive: true });

          // --- YAML frontmatter builder ---
          function buildFrontmatter(fm) {
            if (!fm || Object.keys(fm).length === 0) return '';
            let yaml = '---\n';
            for (const [k, v] of Object.entries(fm)) {
              if (v === null || v === undefined) continue;
              if (Array.isArray(v)) {
                yaml += k + ':\n';
                for (const item of v) {
                  if (typeof item === 'object') {
                    yaml += '  - ' + JSON.stringify(item) + '\n';
                  } else {
                    yaml += '  - ' + item + '\n';
                  }
                }
              } else if (typeof v === 'boolean') {
                yaml += k + ': ' + (v ? 'true' : 'false') + '\n';
              } else {
                const str = String(v);
                const needsQuote = /[:\\[\\]{}#>|*&!@]/.test(str) || str.includes('\\n');
                yaml += k + ': ' + (needsQuote ? JSON.stringify(str) : str) + '\n';
              }
            }
            yaml += '---\n\n';
            return yaml;
          }

          // --- Write subdirectory files (scripts, references, assets) ---
          function writeSubdirFiles(baseDir, subdir, files) {
            if (!files || files.length === 0) return;
            const dir = path.join(baseDir, subdir);
            fs.mkdirSync(dir, { recursive: true });
            for (const f of files) {
              if (!f.filename || !f.content) continue;
              // Security: strip path components
              const safeName = path.basename(f.filename);
              fs.writeFileSync(path.join(dir, safeName), f.content);
              if (subdir === 'scripts') {
                fs.chmodSync(path.join(dir, safeName), 0o755);
              }
            }
          }

          // --- Generate skill plugins ---
          for (const skill of (exts.skills || [])) {
            const slug = skill.slug;
            if (!slug || !/^[a-z0-9][a-z0-9_-]*$/.test(slug)) continue;

            const dir = path.join(pluginsDir, 'ct--' + slug);
            const metaDir = path.join(dir, '.claude-plugin');
            const skillDir = path.join(dir, 'skills', slug);

            fs.mkdirSync(metaDir, { recursive: true });
            fs.mkdirSync(skillDir, { recursive: true });

            // plugin.json â€” only official schema fields
            const pluginMeta = {
              name: 'ct--' + slug,
              version: skill.version || '1.0.0',
              description: skill.tagline || skill.description || skill.name,
              author: { name: 'Community' },
              skills: './skills/' + slug + '/'
            };
            if (skill.license) pluginMeta.license = skill.license;
            if (skill.github_url) pluginMeta.homepage = skill.github_url;
            fs.writeFileSync(path.join(metaDir, 'plugin.json'), JSON.stringify(pluginMeta, null, 2) + '\\n');

            // SKILL.md with frontmatter + content
            const frontmatter = buildFrontmatter(skill.frontmatter);
            const content = skill.content || '# ' + skill.name;
            fs.writeFileSync(path.join(skillDir, 'SKILL.md'), frontmatter + content);

            // Write scripts, references, assets
            writeSubdirFiles(skillDir, 'scripts', skill.scripts);
            writeSubdirFiles(skillDir, 'references', skill.references);
            writeSubdirFiles(skillDir, 'assets', skill.assets);
          }

          // --- Generate agent plugins ---
          for (const ag of (exts.agents || [])) {
            const slug = ag.slug;
            if (!slug || !/^[a-z0-9][a-z0-9_-]*$/.test(slug)) continue;

            const dir = path.join(pluginsDir, 'ct--' + slug);
            const metaDir = path.join(dir, '.claude-plugin');
            const agentsDir = path.join(dir, 'agents');

            fs.mkdirSync(metaDir, { recursive: true });
            fs.mkdirSync(agentsDir, { recursive: true });

            const pluginMeta = {
              name: 'ct--' + slug,
              version: ag.version || '1.0.0',
              description: ag.tagline || ag.description || ag.name,
              author: { name: 'Community' },
              agents: './agents/'
            };
            if (ag.license) pluginMeta.license = ag.license;
            if (ag.github_url) pluginMeta.homepage = ag.github_url;
            fs.writeFileSync(path.join(metaDir, 'plugin.json'), JSON.stringify(pluginMeta, null, 2) + '\\n');

            // Agent .md file with frontmatter
            let agentMd = '---\\n';
            agentMd += 'name: ' + slug + '\\n';
            if (ag.description) agentMd += 'description: ' + ag.description + '\\n';
            agentMd += '---\\n\\n';
            agentMd += ag.content || '# ' + ag.name;
            fs.writeFileSync(path.join(agentsDir, slug + '.md'), agentMd);
          }

          // --- Generate MCP server plugins ---
          for (const mcp of (exts.mcp_servers || [])) {
            const slug = mcp.slug;
            if (!slug || !/^[a-z0-9][a-z0-9_-]*$/.test(slug)) continue;
            if (!mcp.npm_package) continue; // Skip MCP servers without an npm package

            const dir = path.join(pluginsDir, 'ct--' + slug);
            const metaDir = path.join(dir, '.claude-plugin');

            fs.mkdirSync(metaDir, { recursive: true });

            const pluginMeta = {
              name: 'ct--' + slug,
              version: mcp.version || '1.0.0',
              description: mcp.tagline || mcp.description || mcp.name,
              author: { name: 'Community' },
              mcpServers: './.mcp.json'
            };
            if (mcp.license) pluginMeta.license = mcp.license;
            if (mcp.github_url) pluginMeta.homepage = mcp.github_url;
            fs.writeFileSync(path.join(metaDir, 'plugin.json'), JSON.stringify(pluginMeta, null, 2) + '\\n');

            // .mcp.json
            const mcpConfig = {
              mcpServers: {
                [slug]: {
                  command: 'npx',
                  args: ['-y', mcp.npm_package]
                }
              }
            };
            fs.writeFileSync(path.join(dir, '.mcp.json'), JSON.stringify(mcpConfig, null, 2) + '\\n');
          }

          const skillCount = (exts.skills || []).length;
          const agentCount = (exts.agents || []).length;
          const mcpCount = (exts.mcp_servers || []).filter(m => m.npm_package).length;
          console.log('Generated ' + skillCount + ' skill, ' + agentCount + ' agent, ' + mcpCount + ' MCP plugins');
          "

      - name: Update marketplace.json plugin list
        run: |
          node -e "
          const fs = require('fs');
          const path = require('path');
          const manifest = JSON.parse(fs.readFileSync('.claude-plugin/marketplace.json', 'utf8'));

          // Keep the bootstrap claudetools plugin
          const bootstrap = manifest.plugins.filter(p => p.name === 'claudetools');

          // Add generated plugins
          const pluginsDir = 'plugins';
          const generated = [];
          if (fs.existsSync(pluginsDir)) {
            for (const entry of fs.readdirSync(pluginsDir).sort()) {
              const pluginJsonPath = path.join(pluginsDir, entry, '.claude-plugin', 'plugin.json');
              if (fs.existsSync(pluginJsonPath)) {
                const meta = JSON.parse(fs.readFileSync(pluginJsonPath, 'utf8'));
                generated.push({
                  name: meta.name,
                  description: meta.description,
                  version: meta.version,
                  source: './' + path.join(pluginsDir, entry),
                  category: 'community',
                  tags: ['generated']
                });
              }
            }
          }

          manifest.plugins = [...bootstrap, ...generated];
          fs.writeFileSync('.claude-plugin/marketplace.json', JSON.stringify(manifest, null, 2) + '\n');
          console.log('Updated marketplace.json with ' + generated.length + ' generated plugins');
          "

      - name: Commit changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add plugins/ .claude-plugin/marketplace.json
          if git diff --cached --quiet; then
            echo "No changes to commit"
          else
            git commit -m "chore(marketplace): update generated plugin directories"
            git push
          fi
